<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Responsive Admin &amp; Dashboard Template based on Bootstrap 5">
    <meta name="author" content="AdminKit">
    <meta name="keywords"
        content="adminkit, bootstrap, bootstrap 5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web">
    
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="shortcut icon" href="/static/core/img/icons/icon-48x48.png" />

    <link rel="canonical" href="/" />

    <title>Microfinance System</title>

    <link href="/static/core/css/app.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        .text-white * {
            color: #fff !important;
        }
        .alert {
            border: 1px solid !important;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
        }
        .alert-danger {
            background-color: #f8d7da !important;
            border-color: #f5c2c7 !important;
            color: #842029 !important;
        }
        .alert-warning {
            background-color: #fff3cd !important;
            border-color: #ffecb5 !important;
            color: #664d03 !important;
        }
        .alert-success {
            background-color: #d1e7dd !important;
            border-color: #badbcc !important;
            color: #0f5132 !important;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        {% include 'core/layouts/sidebar.html' %}

        <div class="main">
            {% include 'core/layouts/header.html' %}

            <main class="content">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'warning' %}warning{% else %}success{% endif %} alert-dismissible fade show border" role="alert">
                            <strong>
                                {% if message.tags == 'error' %}
                                    <i class="align-middle me-1" data-feather="alert-circle"></i>
                                {% elif message.tags == 'warning' %}
                                    <i class="align-middle me-1" data-feather="alert-triangle"></i>
                                {% else %}
                                    <i class="align-middle me-1" data-feather="check-circle"></i>
                                {% endif %}
                            </strong>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                {% block content %}{% endblock %}
            </main>

            {% include 'core/layouts/footer.html' %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.js"></script>
    <script src="/static/core/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Safe Feather icons replacement that handles invalid icon names gracefully
        function safeFeatherReplace() {
            if (typeof feather === 'undefined') {
                return false;
            }

            // First, try the standard replace method
            try {
                feather.replace();
                return true;
            } catch (error) {
                // If standard replace fails, process icons individually
                console.warn('Standard feather.replace() failed, processing icons individually:', error);
                
                const iconElements = document.querySelectorAll('[data-feather]:not(svg)');
                let successCount = 0;
                let errorCount = 0;
                const invalidIcons = [];

                iconElements.forEach(function(element) {
                    const iconName = element.getAttribute('data-feather');
                    if (!iconName) {
                        return;
                    }

                    // Check if icon exists in feather.icons
                    if (feather.icons && feather.icons[iconName]) {
                        try {
                            // Get attributes to preserve
                            const width = element.getAttribute('width') || element.style.width || '24';
                            const height = element.getAttribute('height') || element.style.height || '24';
                            const classes = element.getAttribute('class') || '';
                            
                            // Replace this specific icon
                            const svg = feather.icons[iconName].toSvg({
                                width: width,
                                height: height,
                                class: classes
                            });
                            element.outerHTML = svg;
                            successCount++;
                        } catch (iconError) {
                            console.warn('Error rendering icon "' + iconName + '":', iconError);
                            invalidIcons.push(iconName);
                            errorCount++;
                            // Remove data-feather to prevent retry
                            element.removeAttribute('data-feather');
                        }
                    } else {
                        console.warn('Invalid Feather icon name: "' + iconName + '"');
                        invalidIcons.push(iconName);
                        errorCount++;
                        // Remove data-feather to prevent retry
                        element.removeAttribute('data-feather');
                    }
                });

                if (successCount > 0) {
                    console.log('Feather icons initialized: ' + successCount + ' icons rendered successfully');
                }
                if (errorCount > 0) {
                    console.warn('Feather icons: ' + errorCount + ' invalid icon(s) skipped: ' + invalidIcons.join(', '));
                }

                return successCount > 0;
            }
        }

        // Initialize Feather icons globally for sidebar and all pages
        function initializeFeatherIcons() {
            if (typeof feather !== 'undefined') {
                try {
                    safeFeatherReplace();
                } catch (error) {
                    console.error('Error initializing Feather icons:', error);
                    // Retry after a short delay
                    setTimeout(function() {
                        if (typeof feather !== 'undefined') {
                            safeFeatherReplace();
                        }
                    }, 100);
                }
            } else {
                console.warn('Feather icons library not loaded');
                // Retry initialization after scripts load
                setTimeout(initializeFeatherIcons, 100);
            }
        }

        // Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeFeatherIcons();

            // Re-initialize icons when Bootstrap dropdowns are shown
            // Wait a bit for Bootstrap to be available
            setTimeout(function() {
                if (typeof bootstrap !== 'undefined') {
                    // Re-initialize icons when dropdowns are shown
                    document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(function(dropdown) {
                        dropdown.addEventListener('shown.bs.dropdown', function() {
                            if (typeof feather !== 'undefined') {
                                safeFeatherReplace();
                            }
                        });
                    });

                    // Re-initialize icons when modals are shown
                    document.querySelectorAll('.modal').forEach(function(modal) {
                        modal.addEventListener('shown.bs.modal', function() {
                            if (typeof feather !== 'undefined') {
                                safeFeatherReplace();
                            }
                        });
                    });
                }
            }, 100);

            // Re-initialize icons when sidebar is toggled (if applicable)
            const sidebarToggle = document.querySelector('.js-sidebar-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    setTimeout(function() {
                        if (typeof feather !== 'undefined') {
                            safeFeatherReplace();
                        }
                    }, 100);
                });
            }

            // Re-initialize icons after AJAX content loads (MutationObserver)
            const observer = new MutationObserver(function(mutations) {
                let shouldReinitialize = false;
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1) { // Element node
                                if (node.querySelector && node.querySelector('[data-feather]')) {
                                    shouldReinitialize = true;
                                }
                                if (node.hasAttribute && node.hasAttribute('data-feather')) {
                                    shouldReinitialize = true;
                                }
                            }
                        });
                    }
                });
                if (shouldReinitialize && typeof feather !== 'undefined') {
                    setTimeout(function() {
                        safeFeatherReplace();
                    }, 50);
                }
            });

            // Observe changes to the document body
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });

        // Also initialize on window load as fallback
        window.addEventListener('load', function() {
            if (typeof feather !== 'undefined') {
                safeFeatherReplace();
            }
        });

        // Make functions available globally for re-initialization
        window.initializeFeatherIcons = initializeFeatherIcons;
        window.safeFeatherReplace = safeFeatherReplace;
    </script>
    {% block extra_js %}{% endblock %}

</body>

</html>